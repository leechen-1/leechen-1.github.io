<!DOCTYPE html><head> <meta http-equiv='Content-Type' content='text/html;charset=utf-8'><meta name='viewport' content='width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no'><title></title><style>a {color: #607fa6;text-decoration:none;word-wrap:break-word;word-break:break-all;}.rich_media_title{padding-bottom:10px;margin-bottom:14px;border-bottom:1px solid #e7e7eb;}.rich_media_meta{display:inline-block;vertical-align:middle;margin-right:8px;margin-bottom:10px;font-size:16px;}.rich_media_meta_text{color:#8c8c8c;}.rich_media_meta_list em {font-style: normal;}@media screen and (max-width:768px){.rich_media{position: relative;padding: 20px 15px 15px;background-color: #fff;}}.rich_media_content * {max-width: 100%!important;box-sizing: border-box!important;-webkit-box-sizing: border-box!important;word-wrap: break-word!important;}a.rich_media_meta_nickname{display: none;}@media screen and (min-width:1025px){.rich_media{position:relative;}a.rich_media_meta_nickname{display:inline-block!important;}span.rich_media_meta_nickname {display: none!important;}.rich_media {width:740px;margin-left:auto;margin-right:auto;}}a.fwjm{display: block;font-size: 12px;color: #ececec;}</style></head><body><div id='js_article' class='rich_media'><div><a href='https://mp.weixin.qq.com/s?__biz=MzIwMzY1OTU1NQ==&mid=2247484743&idx=1&sn=6edce3dff656a0cfcd1308fd25a45953&chksm=96cd450ba1bacc1daca623d845fe5aa3b6381481ac6e660b7cea4092a08233884a58ab942b79&scene=0#rd' target='_blank'>https://mp.weixin.qq.com/s?__biz=MzIwMzY1OTU1NQ==&mid=2247484743&idx=1&sn=6edce3dff656a0cfcd1308fd25a45953&chksm=96cd450ba1bacc1daca623d845fe5aa3b6381481ac6e660b7cea4092a08233884a58ab942b79&scene=0#rd</a><a href='https://www.52pojie.cn' class='fwjm' target='_blank'>提供的爬取软件来源于：52pojie.cn@夜泉  免费使用</a></div><div id="img-content">

                
                <h2 class="rich_media_title" id="activity-name">
                    
                    
                    一次堆外OOM问题的排查过程

                                                                                </h2>
                <div id="meta_content" class="rich_media_meta_list">
                                                                                <span class="rich_media_meta rich_media_meta_text">
                                                谢照东
                                            </span>
                                        
                                        <span class="rich_media_meta rich_media_meta_nickname" id="profileBt">
                      <a href="javascript:void(0);" id="js_name">
                        占小狼的博客                      </a>
                      <div id="js_profile_qrcode" class="profile_container" style="display:none;">
                          <div class="profile_inner">
                              <strong class="profile_nickname">占小狼的博客</strong>
                              <img class="profile_avatar" id="js_profile_qrcode_img" src="" alt="">

                              <p class="profile_meta">
                              <label class="profile_meta_label">微信号</label>
                              <span class="profile_meta_value">whywhy_zj</span>
                              </p>

                              <p class="profile_meta">
                              <label class="profile_meta_label">功能介绍</label>
                              <span class="profile_meta_value">Java进阶技术干货、实践分享，跟着狼哥一起学习JVM、性能调优，欢迎关注。</span>
                              </p>
                              
                          </div>
                          <span class="profile_arrow_wrp" id="js_profile_arrow_wrp">
                              <i class="profile_arrow arrow_out"></i>
                              <i class="profile_arrow arrow_in"></i>
                          </span>
                      </div>
                    </span>


                    <em id="publish_time" class="rich_media_meta rich_media_meta_text"></em>





                </div>
                
                
                
                
                                                
                                                                
                                
                
                <div class="rich_media_content " id="js_content">
                    

                    

                    
                    
                    <h3 style="margin-top: 20px;margin-bottom: 15px;padding-top: 10px;font-weight: bold;line-height: 1.5;font-size: 18px;" data-mpa-powered-by="yiban.io">背景</h3><p style="margin-bottom: 25px;">线上服务有一台机器访问不通（一个管理平台),在公司的服务治理平台上查看服务的状况是正常的，说明进程还在。进程并没有完全crash掉。去线上查看机器日志，发现了大量的OOM异常:</p><figure class="highlight" style="margin-top: 20px;margin-bottom: 20px;overflow: auto;font-size: 13px;color: rgb(77, 77, 76);background: rgb(247, 247, 247);line-height: 1.6;border-radius: 1px;"><table width="NaN" style="width: 738px;"><tbody><tr style="background-color: rgb(249, 249, 249);"><td class="gutter" style="padding: 0px;text-align: left;vertical-align: middle;border-width: initial;border-style: none;border-color: initial;user-select: none;"><pre style="overflow: auto;"><span class="line" style="height: 20px;">1</span><br  /><span class="line" style="height: 20px;">2</span><br  /><span class="line" style="height: 20px;">3</span><br  /><span class="line" style="height: 20px;">4</span><br  /><span class="line" style="height: 20px;">5</span><br  /><span class="line" style="height: 20px;">6</span><br  /><span class="line" style="height: 20px;">7</span><br  /><span class="line" style="height: 20px;">8</span><br  /><span class="line" style="height: 20px;">9</span><br  /><span class="line" style="height: 20px;">10</span><br  /><span class="line" style="height: 20px;">11</span><br  /><span class="line" style="height: 20px;">12</span><br  /><span class="line" style="height: 20px;">13</span><br  /><span class="line" style="height: 20px;">14</span><br  /><span class="line" style="height: 20px;">15</span><br  /><span class="line" style="height: 20px;">16</span><br  /><span class="line" style="height: 20px;">17</span><br  /><span class="line" style="height: 20px;">18</span><br  /><span class="line" style="height: 20px;">19</span><br  /><span class="line" style="height: 20px;">20</span><br  /><span class="line" style="height: 20px;">21</span><br  /><span class="line" style="height: 20px;">22</span><br  /><span class="line" style="height: 20px;">23</span><br  /><span class="line" style="height: 20px;">24</span><br  /><span class="line" style="height: 20px;">25</span><br  /><span class="line" style="height: 20px;">26</span><br  /><span class="line" style="height: 20px;">27</span><br  /><span class="line" style="height: 20px;">28</span><br  /><span class="line" style="height: 20px;">29</span><br  /><span class="line" style="height: 20px;">30</span><br  /><span class="line" style="height: 20px;">31</span><br  /><span class="line" style="height: 20px;">32</span><br  /><span class="line" style="height: 20px;">33</span><br  /><span class="line" style="height: 20px;">34</span><br  /><span class="line" style="height: 20px;">35</span><br  /><span class="line" style="height: 20px;">36</span><br  /><span class="line" style="height: 20px;">37</span><br  /><span class="line" style="height: 20px;">38</span><br  /></pre></td><td class="code" style="padding: 0px;text-align: left;vertical-align: middle;border-width: initial;border-style: none;border-color: initial;"><pre style="overflow: auto;"><span class="line" style="height: 20px;">017-03-15 00:00:00.041 [WARN] qtp1947699202-120772 nio handle failed</span><br  /><span class="line" style="height: 20px;">java.lang.OutOfMemoryError: Direct buffer memory</span><br  /><span class="line" style="height: 20px;"> &nbsp; &nbsp; &nbsp; &nbsp;at java.nio.Bits.reserveMemory(Bits.java:658) ~[?:1.7.0_76]</span><br  /><span class="line" style="height: 20px;"> &nbsp; &nbsp; &nbsp; &nbsp;at java.nio.DirectByteBuffer.&lt;init&gt;(DirectByteBuffer.java:123) ~[?:1.7.0_76]</span><br  /><span class="line" style="height: 20px;"> &nbsp; &nbsp; &nbsp; &nbsp;at java.nio.ByteBuffer.allocateDirect(ByteBuffer.java:306) ~[?:1.7.0_76]</span><br  /><span class="line" style="height: 20px;"> &nbsp; &nbsp; &nbsp; &nbsp;at sun.nio.ch.Util.getTemporaryDirectBuffer(Util.java:174) ~[?:1.7.0_76]</span><br  /><span class="line" style="height: 20px;"> &nbsp; &nbsp; &nbsp; &nbsp;at sun.nio.ch.IOUtil.read(IOUtil.java:195) ~[?:1.7.0_76]</span><br  /><span class="line" style="height: 20px;"> &nbsp; &nbsp; &nbsp; &nbsp;at sun.nio.ch.SocketChannelImpl.read(SocketChannelImpl.java:379) ~[?:1.7.0_76]</span><br  /><span class="line" style="height: 20px;"> &nbsp; &nbsp; &nbsp; &nbsp;at org.eclipse.jetty.io.nio.ChannelEndPoint.fill(ChannelEndPoint.java:235) ~[jetty-io-8.1.10.v20130312.jar:8.1.10.v20130312]</span><br  /><span class="line" style="height: 20px;"> &nbsp; &nbsp; &nbsp; &nbsp;at org.eclipse.jetty.io.nio.SelectChannelEndPoint.fill(SelectChannelEndPoint.java:326) ~[jetty-io-8.1.10.v20130312.jar:8.1.10.v20130312]</span><br  /><span class="line" style="height: 20px;"> &nbsp; &nbsp; &nbsp; &nbsp;at org.eclipse.jetty.http.HttpParser.fill(HttpParser.java:1040) ~[jetty-http-8.1.10.v20130312.jar:8.1.10.v20130312]</span><br  /><span class="line" style="height: 20px;"> &nbsp; &nbsp; &nbsp; &nbsp;at org.eclipse.jetty.http.HttpParser.parseNext(HttpParser.java:280) ~[jetty-http-8.1.10.v20130312.jar:8.1.10.v20130312]</span><br  /><span class="line" style="height: 20px;"> &nbsp; &nbsp; &nbsp; &nbsp;at org.eclipse.jetty.http.HttpParser.parseAvailable(HttpParser.java:235) ~[jetty-http-8.1.10.v20130312.jar:8.1.10.v20130312]</span><br  /><span class="line" style="height: 20px;"> &nbsp; &nbsp; &nbsp; &nbsp;at org.eclipse.jetty.server.AsyncHttpConnection.handle(AsyncHttpConnection.java:82) ~[jetty-server-8.1.10.v20130312.jar:8.1.10.v20130312]</span><br  /><span class="line" style="height: 20px;"> &nbsp; &nbsp; &nbsp; &nbsp;at org.eclipse.jetty.io.nio.SelectChannelEndPoint.handle(SelectChannelEndPoint.java:628) [jetty-io-8.1.10.v20130312.jar:8.1.10.v20130312]</span><br  /><span class="line" style="height: 20px;"> &nbsp; &nbsp; &nbsp; &nbsp;at org.eclipse.jetty.io.nio.SelectChannelEndPoint$1.run(SelectChannelEndPoint.java:52) [jetty-io-8.1.10.v20130312.jar:8.1.10.v20130312]</span><br  /><span class="line" style="height: 20px;"> &nbsp; &nbsp; &nbsp; &nbsp;at org.eclipse.jetty.util.thread.QueuedThreadPool.runJob(QueuedThreadPool.java:608) [jetty-util-8.1.10.v20130312.jar:8.1.10.v20130312]</span><br  /><span class="line" style="height: 20px;"> &nbsp; &nbsp; &nbsp; &nbsp;at org.eclipse.jetty.util.thread.QueuedThreadPool$3.run(QueuedThreadPool.java:543) [jetty-util-8.1.10.v20130312.jar:8.1.10.v20130312]</span><br  /><span class="line" style="height: 20px;"> &nbsp; &nbsp; &nbsp; &nbsp;at java.lang.Thread.run(Thread.java:745) [?:1.7.0_76]</span><br  /><span class="line" style="height: 20px;"> &nbsp; &nbsp; &nbsp; &nbsp;at java.lang.Thread.run(Thread.java:745) [?:1.7.0_76]</span><br  /><span class="line" style="height: 20px;"></span><br  /><span class="line" style="height: 20px;">2017-03-15 00:00:00.718 [WARN] elasticsearch[Thundra][transport_client_worker][T#6]{New I/O worker #6} AbstractNioSelector Unexpected exception in the selector loop.</span><br  /><span class="line" style="height: 20px;">java.lang.OutOfMemoryError: Direct buffer memory</span><br  /><span class="line" style="height: 20px;"> &nbsp; &nbsp; &nbsp; &nbsp;at java.nio.Bits.reserveMemory(Bits.java:658) ~[?:1.7.0_76]</span><br  /><span class="line" style="height: 20px;"> &nbsp; &nbsp; &nbsp; &nbsp;at java.nio.DirectByteBuffer.&lt;init&gt;(DirectByteBuffer.java:123) ~[?:1.7.0_76]</span><br  /><span class="line" style="height: 20px;"> &nbsp; &nbsp; &nbsp; &nbsp;at java.nio.ByteBuffer.allocateDirect(ByteBuffer.java:306) ~[?:1.7.0_76]</span><br  /><span class="line" style="height: 20px;"> &nbsp; &nbsp; &nbsp; &nbsp;at org.jboss.netty.channel.socket.nio.SocketReceiveBufferAllocator.newBuffer(SocketReceiveBufferAllocator.java:64) ~[netty-3.10.5.Final.jar:?]</span><br  /><span class="line" style="height: 20px;"> &nbsp; &nbsp; &nbsp; &nbsp;at org.jboss.netty.channel.socket.nio.SocketReceiveBufferAllocator.get(SocketReceiveBufferAllocator.java:41) ~[netty-3.10.5.Final.jar:?]</span><br  /><span class="line" style="height: 20px;"> &nbsp; &nbsp; &nbsp; &nbsp;at org.jboss.netty.channel.socket.nio.NioWorker.read(NioWorker.java:62) ~[netty-3.10.5.Final.jar:?]</span><br  /><span class="line" style="height: 20px;"> &nbsp; &nbsp; &nbsp; &nbsp;at org.jboss.netty.channel.socket.nio.AbstractNioWorker.process(AbstractNioWorker.java:108) ~[netty-3.10.5.Final.jar:?]</span><br  /><span class="line" style="height: 20px;"> &nbsp; &nbsp; &nbsp; &nbsp;at org.jboss.netty.channel.socket.nio.AbstractNioSelector.run(AbstractNioSelector.java:337) [netty-3.10.5.Final.jar:?]</span><br  /><span class="line" style="height: 20px;"> &nbsp; &nbsp; &nbsp; &nbsp;at org.jboss.netty.channel.socket.nio.AbstractNioWorker.run(AbstractNioWorker.java:89) [netty-3.10.5.Final.jar:?]</span><br  /><span class="line" style="height: 20px;"> &nbsp; &nbsp; &nbsp; &nbsp;at org.jboss.netty.channel.socket.nio.NioWorker.run(NioWorker.java:178) [netty-3.10.5.Final.jar:?]</span><br  /><span class="line" style="height: 20px;"> &nbsp; &nbsp; &nbsp; &nbsp;at org.jboss.netty.util.ThreadRenamingRunnable.run(ThreadRenamingRunnable.java:108) [netty-3.10.5.Final.jar:?]</span><br  /><span class="line" style="height: 20px;"> &nbsp; &nbsp; &nbsp; &nbsp;at org.jboss.netty.util.internal.DeadLockProofWorker$1.run(DeadLockProofWorker.java:42) [netty-3.10.5.Final.jar:?]</span><br  /><span class="line" style="height: 20px;"> &nbsp; &nbsp; &nbsp; &nbsp;at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1145) [?:1.7.0_76]</span><br  /><span class="line" style="height: 20px;"> &nbsp; &nbsp; &nbsp; &nbsp;at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:615) [?:1.7.0_76]</span><br  /><span class="line" style="height: 20px;"> &nbsp; &nbsp; &nbsp; &nbsp;at java.lang.Thread.run(Thread.java:745) [?:1.7.0_76]</span><br  /></pre></td></tr></tbody></table></figure><p><br  /></p><p style="margin-bottom: 25px;">可以发现是Direct buffer memory的native memory满了，无法分配堆外内存。由于jetty使用的是nio，nio里面大量的使用native memeory。无法分配native memory之后，导致所有的请求都无效</p><h3 style="margin-top: 20px;margin-bottom: 15px;padding-top: 10px;font-weight: bold;line-height: 1.5;font-size: 18px;">排查</h3><p style="margin-bottom: 25px;">赶快去看了下监控系统上面内存和线程的一些监控指标<br  /><img class="" data-ratio="0.29708029197080293" src="images/T0pUYjNB5cxGqgtVI0JejrZACBQanerM7jIvPPakibtFy9XrtI6wznEfZYy3ibPXBmARZKFZHWVcPLwoE4UI7VTQ.png" data-type="png" data-w="2740" style="border-width: 1px;border-style: solid;border-color: rgb(221, 221, 221);margin-right: auto;margin-left: auto;cursor: -webkit-zoom-in;box-sizing: border-box;padding: 3px;display: block !important;"  /></p><p style="margin-bottom: 25px;"><img class="" data-ratio="0.3026124818577649" src="images/T0pUYjNB5cxGqgtVI0JejrZACBQanerM6nChYm6NpZgsic2ibibq8bqydBQ28fKvZvP0o4UzYcLorVleXC8EC5qhg.png" data-type="png" data-w="2756" style="border-width: 1px;border-style: solid;border-color: rgb(221, 221, 221);margin-right: auto;margin-left: auto;cursor: -webkit-zoom-in;box-sizing: border-box;padding: 3px;display: block !important;"  /><br  /><img class="" data-ratio="0.3007299270072993" src="images/T0pUYjNB5cxGqgtVI0JejrZACBQanerMbwLd2n3ZSibu7bCUTSuRKe1zqX23Xm2icoANNnnUxYJ4JSogBGWsukNQ.png" data-type="png" data-w="2740" style="border-width: 1px;border-style: solid;border-color: rgb(221, 221, 221);margin-right: auto;margin-left: auto;cursor: -webkit-zoom-in;box-sizing: border-box;padding: 3px;display: block !important;"  /><br  /><img class="" data-ratio="0.2943754565376187" src="images/T0pUYjNB5cxGqgtVI0JejrZACBQanerMB3QwoVjxvKeP0ok8GyIUygrJX9D3jSk9xDY2DtibusmysrAK31PyJrA.png" data-type="png" data-w="2738" style="border-width: 1px;border-style: solid;border-color: rgb(221, 221, 221);margin-right: auto;margin-left: auto;cursor: -webkit-zoom-in;box-sizing: border-box;padding: 3px;display: block !important;"  /><br  /><img class="" data-ratio="0.30377906976744184" src="images/T0pUYjNB5cxGqgtVI0JejrZACBQanerMIzPl2PhT7iac9ia1u3saZicOAYj2guS3kmacodDGMUQvIp17JJF5xRldA.png" data-type="png" data-w="2752" style="border-width: 1px;border-style: solid;border-color: rgb(221, 221, 221);margin-right: auto;margin-left: auto;cursor: -webkit-zoom-in;box-sizing: border-box;padding: 3px;display: block !important;"  /><br  /><img class="" data-ratio="0.3078602620087336" src="images/T0pUYjNB5cxGqgtVI0JejrZACBQanerMQcLaFs3aMzcUSzKrsGiadtk1HR3lP4eT4CzpgGLvohn8dGbgQTexC4Q.png" data-type="png" data-w="2748" style="border-width: 1px;border-style: solid;border-color: rgb(221, 221, 221);margin-right: auto;margin-left: auto;cursor: -webkit-zoom-in;box-sizing: border-box;padding: 3px;display: block !important;"  /></p><p style="margin-bottom: 25px;">文件描述符、runable线程数 、directbuffer 已经达到了2G（我们-Xmx的值），老年代已经1G多了。但是没有fullGC。youngc次数也不是很多，但是出现问题的机器young gc明显比没出现问题的机器多</p><p style="margin-bottom: 25px;">根据上面的指标，初步定位是由线程创建的网络连接造成了native memory不够 。最上面的log日志显示除了jetty之外还有一个就是ElasticSearch client的worker线程也出现的分配OOM。回想上次开发新功能的时候，会创建大量的ES client连接，会不会是这个问题。查看代码发现确实是因为创建了大量的ES连接，但是并没有主动close掉。导致线程数暴增，由于ElasticSearch client是用的netty做的网络层，使用了大量的DirectByteBuffer.引用一直存在(client线程一直存在)，无法GC掉，DirectByteBuffer对象，导致native memory也无法回收。下图是用jprofile测试ElasticSearch client的时候发现的。可以得到的是ElasticSearch client确实会产生大量的DirectByteBuffer<br  /><img class="" data-ratio="0.49775280898876406" src="images/T0pUYjNB5cxGqgtVI0JejrZACBQanerM6BIEg9ziawWRo4iafoIJ4Eh3NXwFatLMibdGib6z5hfOdKbIzuiaX8Xzgrg.png" data-type="png" data-w="1780" style="border-width: 1px;border-style: solid;border-color: rgb(221, 221, 221);margin-right: auto;margin-left: auto;cursor: -webkit-zoom-in;box-sizing: border-box;padding: 3px;display: block !important;"  /><br  /><img class="" data-ratio="0.5849514563106796" src="images/T0pUYjNB5cxGqgtVI0JejrZACBQanerMk7kcs5RXwnYS5ibn0CBcEkibvrfarxQKy5nNSzmwvD22JW4do3YxFJBA.png" data-type="png" data-w="2472" style="border-width: 1px;border-style: solid;border-color: rgb(221, 221, 221);margin-right: auto;margin-left: auto;cursor: -webkit-zoom-in;box-sizing: border-box;padding: 3px;display: block !important;"  /></p><h4 style="margin-top: 20px;margin-bottom: 15px;padding-top: 10px;font-weight: bold;line-height: 1.5;">old gen为什么会多呢？</h4><p style="margin-bottom: 25px;">那为什么old gen的对象这么多呢？其实就是一大堆的bytebuffer冰山对象进入了oldgen ，然而fullgc都没有发生，bytebuffer不会被回收，但是这个时候native memory已经被分配完了，所以OOM了。查了资料发现我们在JVM参数中添加了这个:-XX:+DisableExplicitGC.这个参数会导致显示调用System.gc()无效。然而在分配native memory中有这样一段代码:</p><figure class="highlight java" style="margin-top: 20px;margin-bottom: 20px;overflow: auto;font-size: 13px;color: rgb(77, 77, 76);background: rgb(247, 247, 247);line-height: 1.6;border-radius: 1px;"><table width="NaN"><tbody><tr style="background-color: rgb(249, 249, 249);"><td class="gutter" style="padding: 0px;text-align: left;vertical-align: middle;border-width: initial;border-style: none;border-color: initial;user-select: none;"><pre style="overflow: auto;"><span class="line" style="height: 20px;">1</span><br  /><span class="line" style="height: 20px;">2</span><br  /><span class="line" style="height: 20px;">3</span><br  /><span class="line" style="height: 20px;">4</span><br  /><span class="line" style="height: 20px;">5</span><br  /><span class="line" style="height: 20px;">6</span><br  /><span class="line" style="height: 20px;">7</span><br  /><span class="line" style="height: 20px;">8</span><br  /><span class="line" style="height: 20px;">9</span><br  /><span class="line" style="height: 20px;">10</span><br  /><span class="line" style="height: 20px;">11</span><br  /><span class="line" style="height: 20px;">12</span><br  /><span class="line" style="height: 20px;">13</span><br  /><span class="line" style="height: 20px;">14</span><br  /><span class="line" style="height: 20px;">15</span><br  /><span class="line" style="height: 20px;">16</span><br  /><span class="line" style="height: 20px;">17</span><br  /><span class="line" style="height: 20px;">18</span><br  /><span class="line" style="height: 20px;">19</span><br  /><span class="line" style="height: 20px;">20</span><br  /><span class="line" style="height: 20px;">21</span><br  /><span class="line" style="height: 20px;">22</span><br  /><span class="line" style="height: 20px;">23</span><br  /><span class="line" style="height: 20px;">24</span><br  /><span class="line" style="height: 20px;">25</span><br  /><span class="line" style="height: 20px;">26</span><br  /><span class="line" style="height: 20px;">27</span><br  /><span class="line" style="height: 20px;">28</span><br  /><span class="line" style="height: 20px;">29</span><br  /><span class="line" style="height: 20px;">30</span><br  /><span class="line" style="height: 20px;">31</span><br  /><span class="line" style="height: 20px;">32</span><br  /><span class="line" style="height: 20px;">33</span><br  /><span class="line" style="height: 20px;">34</span><br  /><span class="line" style="height: 20px;">35</span><br  /><span class="line" style="height: 20px;">36</span><br  /><span class="line" style="height: 20px;">37</span><br  /></pre></td><td class="code" style="padding: 0px;text-align: left;vertical-align: middle;border-width: initial;border-style: none;border-color: initial;"><pre style="overflow: auto;"><span class="line" style="height: 20px;"><span class="comment" style="color: rgb(142, 144, 140);">// These methods should be called whenever direct memory is allocated or</span></span><br  /><span class="line" style="height: 20px;"><span class="comment" style="color: rgb(142, 144, 140);">// freed. &nbsp;They allow the user to control the amount of direct memory</span></span><br  /><span class="line" style="height: 20px;"><span class="comment" style="color: rgb(142, 144, 140);">// which a process may access. &nbsp;All sizes are specified in bytes.</span></span><br  /><span class="line" style="height: 20px;"><span class="function" style="color: rgb(66, 113, 174);"><span class="keyword" style="color: rgb(137, 89, 168);">static</span> <span class="keyword" style="color: rgb(137, 89, 168);">void</span> <span class="title" style="color: rgb(62, 153, 159);">reserveMemory</span><span class="params" style="color: rgb(245, 135, 31);">(<span class="keyword" style="color: rgb(137, 89, 168);">long</span> size, <span class="keyword" style="color: rgb(137, 89, 168);">int</span> cap)</span> </span>{</span><br  /><span class="line" style="height: 20px;"> &nbsp; &nbsp;<span class="keyword" style="color: rgb(137, 89, 168);">synchronized</span> (Bits.class) {</span><br  /><span class="line" style="height: 20px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="keyword" style="color: rgb(137, 89, 168);">if</span> (!memoryLimitSet &amp;&amp; VM.isBooted()) {</span><br  /><span class="line" style="height: 20px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;maxMemory = VM.maxDirectMemory();</span><br  /><span class="line" style="height: 20px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;memoryLimitSet = <span class="keyword" style="color: rgb(137, 89, 168);">true</span>;</span><br  /><span class="line" style="height: 20px;"> &nbsp; &nbsp; &nbsp; &nbsp;}</span><br  /><span class="line" style="height: 20px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="comment" style="color: rgb(142, 144, 140);">// -XX:MaxDirectMemorySize limits the total capacity rather than the</span></span><br  /><span class="line" style="height: 20px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="comment" style="color: rgb(142, 144, 140);">// actual memory usage, which will differ when buffers are page</span></span><br  /><span class="line" style="height: 20px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="comment" style="color: rgb(142, 144, 140);">// aligned.</span></span><br  /><span class="line" style="height: 20px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="keyword" style="color: rgb(137, 89, 168);">if</span> (cap &lt;= maxMemory - totalCapacity) {</span><br  /><span class="line" style="height: 20px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;reservedMemory += size;</span><br  /><span class="line" style="height: 20px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;totalCapacity += cap;</span><br  /><span class="line" style="height: 20px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;count++;</span><br  /><span class="line" style="height: 20px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="keyword" style="color: rgb(137, 89, 168);">return</span>;</span><br  /><span class="line" style="height: 20px;"> &nbsp; &nbsp; &nbsp; &nbsp;}</span><br  /><span class="line" style="height: 20px;"> &nbsp; &nbsp;}</span><br  /><span class="line" style="height: 20px;"> &nbsp; &nbsp;<span class="comment" style="color: rgb(142, 144, 140);">//提醒jvm该gc了，回收下死掉的对象</span></span><br  /><span class="line" style="height: 20px;"> &nbsp; &nbsp;System.gc();</span><br  /><span class="line" style="height: 20px;"> &nbsp; &nbsp;<span class="keyword" style="color: rgb(137, 89, 168);">try</span> {</span><br  /><span class="line" style="height: 20px;"> &nbsp; &nbsp; &nbsp; &nbsp;Thread.sleep(<span class="number" style="color: rgb(113, 140, 0);">100</span>);</span><br  /><span class="line" style="height: 20px;"> &nbsp; &nbsp;} <span class="keyword" style="color: rgb(137, 89, 168);">catch</span> (InterruptedException x) {</span><br  /><span class="line" style="height: 20px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="comment" style="color: rgb(142, 144, 140);">// Restore interrupt status</span></span><br  /><span class="line" style="height: 20px;"> &nbsp; &nbsp; &nbsp; &nbsp;Thread.currentThread().interrupt();</span><br  /><span class="line" style="height: 20px;"> &nbsp; &nbsp;}</span><br  /><span class="line" style="height: 20px;"> &nbsp; &nbsp;<span class="keyword" style="color: rgb(137, 89, 168);">synchronized</span> (Bits.class) {</span><br  /><span class="line" style="height: 20px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="comment" style="color: rgb(142, 144, 140);">//计算可分配的是否已经超过maxMemeory，超过则抛出OOM异常</span></span><br  /><span class="line" style="height: 20px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="keyword" style="color: rgb(137, 89, 168);">if</span> (totalCapacity + cap &gt; maxMemory)</span><br  /><span class="line" style="height: 20px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="keyword" style="color: rgb(137, 89, 168);">throw</span> <span class="keyword" style="color: rgb(137, 89, 168);">new</span> OutOfMemoryError(<span class="string" style="color: rgb(113, 140, 0);">"Direct buffer memory"</span>);</span><br  /><span class="line" style="height: 20px;"> &nbsp; &nbsp; &nbsp; &nbsp;reservedMemory += size;</span><br  /><span class="line" style="height: 20px;"> &nbsp; &nbsp; &nbsp; &nbsp;totalCapacity += cap;</span><br  /><span class="line" style="height: 20px;"> &nbsp; &nbsp; &nbsp; &nbsp;count++;</span><br  /><span class="line" style="height: 20px;"> &nbsp; &nbsp;}</span><br  /><span class="line" style="height: 20px;"> </span><br  /><span class="line" style="height: 20px;">}</span><br  /></pre></td></tr></tbody></table></figure><p><br  /></p><p style="margin-bottom: 25px;">通过这段代码发现，每次分配native memory的时候会通知jvm进行一次GC。如果我们配置了上面的jvm参数会导致这行代码不起任何作用。old gen里面的对象就算死掉也不会回收，除非old gen本身满了，但是通过上面的old gen使用了1G，还没有到old gen的最大值。没有full gc所以native memory一直没有被回收。其实就算我们没有设置jvm参数估计也会OOM ，因为bytebuffer因为线程只有的关系不会全部死掉。大部分bytebuffer也不会被回收</p><h3 style="margin-top: 20px;margin-bottom: 15px;padding-top: 10px;font-weight: bold;line-height: 1.5;font-size: 18px;">关于DirectByteBuffer</h3><p style="margin-bottom: 25px;"><img class="" data-ratio="0.503030303030303" src="images/T0pUYjNB5cxGqgtVI0JejrZACBQanerMib77WtwLQOufwibw70IZwicXo1TpARIdX7SOHFqoSuzUmTu317eqsor4Q.png" data-type="png" data-w="660" style="border-width: 1px;border-style: solid;border-color: rgb(221, 221, 221);margin-right: auto;margin-left: auto;cursor: -webkit-zoom-in;box-sizing: border-box;padding: 3px;display: block !important;"  /></p><ul style="list-style-type: none;" class=" list-paddingleft-2"><li><p>Perm中主要放一些class和meta信息，常量池，静态字段等。这些东西都放在所谓的方法区中，在hotspot中也就是“持久带”。</p></li><li><p>对于习惯在HotSpot虚拟机上开发和部署程序的开发者来说，很多人愿意把方法区称为“永久代”（Permanent Generation），本质上两者并不等价，仅仅是因为HotSpot虚拟机的设计团队选择把GC分代收集扩展至方法区，或者说使用永久代来实现方法区而已</p></li><li><p>用-Xmx -Xms -Xmn 指定堆的最大值、初始值、和年轻带的大小，由上图可知young区也分为Eden 、from 、to上个区，比例默认是8:1:1 可以用-XX:SurvivorRatio设置年轻代中Eden区与Survivor区的大小比值</p></li><li><p>堆内内存由JVM gc统一管理回收,关于垃圾回收算法，这里不再赘述</p></li></ul><h4 style="margin-top: 20px;margin-bottom: 15px;padding-top: 10px;font-weight: bold;line-height: 1.5;">堆外内存（off-heap memory)</h4><p style="margin-bottom: 25px;">和堆内内存相对应，堆外内存就是把内存对象分配在Java虚拟机的堆以外的内存，这些内存直接受操作系统管理（而不是虚拟机），这样做的结果就是能够在一定程度上减少垃圾回收对应用程序造成的影响。堆外内存默认是和-Xmx默认一样大，也可以使用-XX:MaxDirectMemorySize指定堆外内存大小</p><p style="margin-bottom: 25px;">作为JAVA开发者我们经常用java.nio.DirectByteBuffer对象进行堆外内存的管理和使用，它会在对象创建的时候就分配堆外内存。DirectByteBuffer类是在Java Heap外分配内存，对堆外内存的申请主要是通过成员变量unsafe来操作。关于Cleaner回收native memory又是另一个重要的点了。比如：为什么不用finalize来回收native memory。另外找机会写.</p><p style="margin-bottom: 25px;">我们可以知道的是，随着DirectByteBuffer被GC掉之后，被分配的native memory会被回收</p><figure class="highlight java" style="margin-top: 20px;margin-bottom: 20px;overflow: auto;font-size: 13px;color: rgb(77, 77, 76);background: rgb(247, 247, 247);line-height: 1.6;border-radius: 1px;"><table width="NaN"><tbody><tr style="background-color: rgb(249, 249, 249);"><td class="gutter" style="padding: 0px;text-align: left;vertical-align: middle;border-width: initial;border-style: none;border-color: initial;user-select: none;"><pre style="overflow: auto;"><span class="line" style="height: 20px;">1</span><br  /><span class="line" style="height: 20px;">2</span><br  /><span class="line" style="height: 20px;">3</span><br  /><span class="line" style="height: 20px;">4</span><br  /><span class="line" style="height: 20px;">5</span><br  /><span class="line" style="height: 20px;">6</span><br  /><span class="line" style="height: 20px;">7</span><br  /><span class="line" style="height: 20px;">8</span><br  /><span class="line" style="height: 20px;">9</span><br  /><span class="line" style="height: 20px;">10</span><br  /><span class="line" style="height: 20px;">11</span><br  /><span class="line" style="height: 20px;">12</span><br  /><span class="line" style="height: 20px;">13</span><br  /><span class="line" style="height: 20px;">14</span><br  /><span class="line" style="height: 20px;">15</span><br  /><span class="line" style="height: 20px;">16</span><br  /><span class="line" style="height: 20px;">17</span><br  /><span class="line" style="height: 20px;">18</span><br  /><span class="line" style="height: 20px;">19</span><br  /><span class="line" style="height: 20px;">20</span><br  /><span class="line" style="height: 20px;">21</span><br  /><span class="line" style="height: 20px;">22</span><br  /><span class="line" style="height: 20px;">23</span><br  /><span class="line" style="height: 20px;">24</span><br  /><span class="line" style="height: 20px;">25</span><br  /><span class="line" style="height: 20px;">26</span><br  /><span class="line" style="height: 20px;">27</span><br  /><span class="line" style="height: 20px;">28</span><br  /><span class="line" style="height: 20px;">29</span><br  /><span class="line" style="height: 20px;">30</span><br  /><span class="line" style="height: 20px;">31</span><br  /><span class="line" style="height: 20px;">32</span><br  /><span class="line" style="height: 20px;">33</span><br  /><span class="line" style="height: 20px;">34</span><br  /><span class="line" style="height: 20px;">35</span><br  /><span class="line" style="height: 20px;">36</span><br  /><span class="line" style="height: 20px;">37</span><br  /><span class="line" style="height: 20px;">38</span><br  /><span class="line" style="height: 20px;">39</span><br  /><span class="line" style="height: 20px;">40</span><br  /><span class="line" style="height: 20px;">41</span><br  /><span class="line" style="height: 20px;">42</span><br  /><span class="line" style="height: 20px;">43</span><br  /><span class="line" style="height: 20px;">44</span><br  /><span class="line" style="height: 20px;">45</span><br  /><span class="line" style="height: 20px;">46</span><br  /><span class="line" style="height: 20px;">47</span><br  /><span class="line" style="height: 20px;">48</span><br  /><span class="line" style="height: 20px;">49</span><br  /><span class="line" style="height: 20px;">50</span><br  /><span class="line" style="height: 20px;">51</span><br  /><span class="line" style="height: 20px;">52</span><br  /><span class="line" style="height: 20px;">53</span><br  /><span class="line" style="height: 20px;">54</span><br  /><span class="line" style="height: 20px;">55</span><br  /></pre></td><td class="code" style="padding: 0px;text-align: left;vertical-align: middle;border-width: initial;border-style: none;border-color: initial;"><pre style="overflow: auto;"><span class="line" style="height: 20px;">DirectByteBuffer(<span class="keyword" style="color: rgb(137, 89, 168);">int</span> cap) { &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><br  /><span class="line" style="height: 20px;"> &nbsp; &nbsp;<span class="keyword" style="color: rgb(137, 89, 168);">super</span>(-<span class="number" style="color: rgb(113, 140, 0);">1</span>, <span class="number" style="color: rgb(113, 140, 0);">0</span>, cap, cap);</span><br  /><span class="line" style="height: 20px;"> &nbsp; &nbsp;<span class="comment" style="color: rgb(142, 144, 140);">//内存是否按页分配对齐</span></span><br  /><span class="line" style="height: 20px;"> &nbsp; &nbsp;<span class="keyword" style="color: rgb(137, 89, 168);">boolean</span> pa = VM.isDirectMemoryPageAligned();</span><br  /><span class="line" style="height: 20px;"> &nbsp; &nbsp;<span class="comment" style="color: rgb(142, 144, 140);">//获取每页内存大小</span></span><br  /><span class="line" style="height: 20px;"> &nbsp; &nbsp;<span class="keyword" style="color: rgb(137, 89, 168);">int</span> ps = Bits.pageSize();</span><br  /><span class="line" style="height: 20px;"> &nbsp; &nbsp;<span class="comment" style="color: rgb(142, 144, 140);">//分配内存的大小，如果是按页对齐方式，需要再加一页内存的容量</span></span><br  /><span class="line" style="height: 20px;"> &nbsp; &nbsp;<span class="keyword" style="color: rgb(137, 89, 168);">long</span> size = Math.max(<span class="number" style="color: rgb(113, 140, 0);">1L</span>, (<span class="keyword" style="color: rgb(137, 89, 168);">long</span>)cap + (pa ? ps : <span class="number" style="color: rgb(113, 140, 0);">0</span>));</span><br  /><span class="line" style="height: 20px;"> &nbsp; &nbsp;<span class="comment" style="color: rgb(142, 144, 140);">//用Bits类保存总分配内存(按页分配)的大小和实际内存的大小</span></span><br  /><span class="line" style="height: 20px;"> &nbsp; &nbsp;Bits.reserveMemory(size, cap);</span><br  /><span class="line" style="height: 20px;"> </span><br  /><span class="line" style="height: 20px;"> &nbsp; &nbsp;<span class="keyword" style="color: rgb(137, 89, 168);">long</span> base = <span class="number" style="color: rgb(113, 140, 0);">0</span>;</span><br  /><span class="line" style="height: 20px;"> &nbsp; &nbsp;<span class="keyword" style="color: rgb(137, 89, 168);">try</span> {</span><br  /><span class="line" style="height: 20px;"> &nbsp; &nbsp; &nbsp; <span class="comment" style="color: rgb(142, 144, 140);">//在堆外内存的基地址，指定内存大小</span></span><br  /><span class="line" style="height: 20px;"> &nbsp; &nbsp; &nbsp; &nbsp;base = unsafe.allocateMemory(size);</span><br  /><span class="line" style="height: 20px;"> &nbsp; &nbsp;} <span class="keyword" style="color: rgb(137, 89, 168);">catch</span> (OutOfMemoryError x) {</span><br  /><span class="line" style="height: 20px;"> &nbsp; &nbsp; &nbsp; &nbsp;Bits.unreserveMemory(size, cap);</span><br  /><span class="line" style="height: 20px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="keyword" style="color: rgb(137, 89, 168);">throw</span> x;</span><br  /><span class="line" style="height: 20px;"> &nbsp; &nbsp;}</span><br  /><span class="line" style="height: 20px;"> &nbsp; &nbsp;unsafe.setMemory(base, size, (<span class="keyword" style="color: rgb(137, 89, 168);">byte</span>) <span class="number" style="color: rgb(113, 140, 0);">0</span>);</span><br  /><span class="line" style="height: 20px;"> &nbsp; &nbsp;<span class="comment" style="color: rgb(142, 144, 140);">//计算堆外内存的基地址</span></span><br  /><span class="line" style="height: 20px;"> &nbsp; &nbsp;<span class="keyword" style="color: rgb(137, 89, 168);">if</span> (pa &amp;&amp; (base % ps != <span class="number" style="color: rgb(113, 140, 0);">0</span>)) {</span><br  /><span class="line" style="height: 20px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="comment" style="color: rgb(142, 144, 140);">// Round up to page boundary</span></span><br  /><span class="line" style="height: 20px;"> &nbsp; &nbsp; &nbsp; &nbsp;address = base + ps - (base &amp; (ps - <span class="number" style="color: rgb(113, 140, 0);">1</span>));</span><br  /><span class="line" style="height: 20px;"> &nbsp; &nbsp;} <span class="keyword" style="color: rgb(137, 89, 168);">else</span> {</span><br  /><span class="line" style="height: 20px;"> &nbsp; &nbsp; &nbsp; &nbsp;address = base;</span><br  /><span class="line" style="height: 20px;"> &nbsp; &nbsp;}</span><br  /><span class="line" style="height: 20px;"> &nbsp; &nbsp;<span class="comment" style="color: rgb(142, 144, 140);">//当this对象即directByteBuffer被gc回收时，释放native memory（为什么不用）</span></span><br  /><span class="line" style="height: 20px;"> &nbsp; &nbsp;cleaner = Cleaner.create(<span class="keyword" style="color: rgb(137, 89, 168);">this</span>, <span class="keyword" style="color: rgb(137, 89, 168);">new</span> Deallocator(base, size, cap));</span><br  /><span class="line" style="height: 20px;"> &nbsp; &nbsp;att = <span class="keyword" style="color: rgb(137, 89, 168);">null</span>;</span><br  /><span class="line" style="height: 20px;">}</span><br  /><span class="line" style="height: 20px;"> &nbsp;</span><br  /><span class="line" style="height: 20px;"><span class="keyword" style="color: rgb(137, 89, 168);">private</span> <span class="keyword" style="color: rgb(137, 89, 168);">static</span> <span class="class"><span class="keyword" style="color: rgb(137, 89, 168);">class</span> <span class="title" style="color: rgb(62, 153, 159);">Deallocator</span> <span class="keyword" style="color: rgb(137, 89, 168);">implements</span> <span class="title" style="color: rgb(62, 153, 159);">Runnable</span> &nbsp;</span>{</span><br  /><span class="line" style="height: 20px;"> &nbsp; &nbsp;<span class="keyword" style="color: rgb(137, 89, 168);">private</span> <span class="keyword" style="color: rgb(137, 89, 168);">static</span> Unsafe unsafe = Unsafe.getUnsafe();</span><br  /><span class="line" style="height: 20px;"> &nbsp; &nbsp;<span class="keyword" style="color: rgb(137, 89, 168);">private</span> <span class="keyword" style="color: rgb(137, 89, 168);">long</span> address;</span><br  /><span class="line" style="height: 20px;"> &nbsp; &nbsp;<span class="keyword" style="color: rgb(137, 89, 168);">private</span> <span class="keyword" style="color: rgb(137, 89, 168);">long</span> size;</span><br  /><span class="line" style="height: 20px;"> &nbsp; &nbsp;<span class="keyword" style="color: rgb(137, 89, 168);">private</span> <span class="keyword" style="color: rgb(137, 89, 168);">int</span> capacity;</span><br  /><span class="line" style="height: 20px;"> &nbsp; &nbsp;<span class="function" style="color: rgb(66, 113, 174);"><span class="keyword" style="color: rgb(137, 89, 168);">private</span> <span class="title" style="color: rgb(62, 153, 159);">Deallocator</span><span class="params" style="color: rgb(245, 135, 31);">(<span class="keyword" style="color: rgb(137, 89, 168);">long</span> address, <span class="keyword" style="color: rgb(137, 89, 168);">long</span> size, <span class="keyword" style="color: rgb(137, 89, 168);">int</span> capacity)</span> </span>{</span><br  /><span class="line" style="height: 20px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="keyword" style="color: rgb(137, 89, 168);">assert</span> (address != <span class="number" style="color: rgb(113, 140, 0);">0</span>);</span><br  /><span class="line" style="height: 20px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="keyword" style="color: rgb(137, 89, 168);">this</span>.address = address;</span><br  /><span class="line" style="height: 20px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="keyword" style="color: rgb(137, 89, 168);">this</span>.size = size;</span><br  /><span class="line" style="height: 20px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="keyword" style="color: rgb(137, 89, 168);">this</span>.capacity = capacity;</span><br  /><span class="line" style="height: 20px;"> &nbsp; &nbsp;}</span><br  /><span class="line" style="height: 20px;"> </span><br  /><span class="line" style="height: 20px;"> &nbsp; &nbsp;<span class="function" style="color: rgb(66, 113, 174);"><span class="keyword" style="color: rgb(137, 89, 168);">public</span> <span class="keyword" style="color: rgb(137, 89, 168);">void</span> <span class="title" style="color: rgb(62, 153, 159);">run</span><span class="params" style="color: rgb(245, 135, 31);">()</span> </span>{</span><br  /><span class="line" style="height: 20px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="keyword" style="color: rgb(137, 89, 168);">if</span> (address == <span class="number" style="color: rgb(113, 140, 0);">0</span>) {</span><br  /><span class="line" style="height: 20px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="comment" style="color: rgb(142, 144, 140);">// Paranoia</span></span><br  /><span class="line" style="height: 20px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="keyword" style="color: rgb(137, 89, 168);">return</span>;</span><br  /><span class="line" style="height: 20px;"> &nbsp; &nbsp; &nbsp; &nbsp;}</span><br  /><span class="line" style="height: 20px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="comment" style="color: rgb(142, 144, 140);">//回收native memory</span></span><br  /><span class="line" style="height: 20px;"> &nbsp; &nbsp; &nbsp; &nbsp;unsafe.freeMemory(address);</span><br  /><span class="line" style="height: 20px;"> &nbsp; &nbsp; &nbsp; &nbsp;address = <span class="number" style="color: rgb(113, 140, 0);">0</span>;</span><br  /><span class="line" style="height: 20px;"> &nbsp; &nbsp; &nbsp; &nbsp;Bits.unreserveMemory(size, capacity);</span><br  /><span class="line" style="height: 20px;"> &nbsp; &nbsp;}</span><br  /><span class="line" style="height: 20px;">}</span></pre></td></tr></tbody></table></figure><h3 style="margin-top: 20px;margin-bottom: 15px;padding-top: 10px;font-weight: bold;line-height: 1.5;font-size: 18px;">堆外内存溢出</h3><p style="margin-bottom: 25px;">我们知道了回收堆内的DriectByteBuffer就会回收native memory，出现OOM的情况就是native memory被分配完了。也同时因为这个原因，假设进入Old gen的对象本来已经死了，但是并没有full gc回收，native memory不能被及时回收。为了避免这种情况，在分配DirectByteByffer的时候会主动调用一次System.GC().通知JVM进行一次full gc。定期清理堆中的垃圾，及时的释放native memory。</p><p style="margin-bottom: 25px;">但是用了-XX:+DisableExplicitGC参数后，System.gc()的调用就会变成一个空调用，完全不会触发任何GC（但是“函数调用”本身的开销还是存在的).为啥要用这个参数呢？最主要的原因是为了防止某些手贱的同学在代码里到处写System.gc()的调用而STW干扰了程序的正常运行吧。有些应用程序本来可能正常跑一天也不会出一次full GC，但就是因为有人在代码里调用了System.gc()而不得不间歇性被暂停。也有些时候这些调用是在某些库或框架里写的，改不了它们的代码但又不想被这些调用干扰也会用这参数。</p><p style="margin-bottom: 25px;">但是如果使用堆外内存，同时使用了这个参数，比如同时满足下面3个条件，就很容易发生OOM</p><ol class=" list-paddingleft-2" style=""><li><p>应用本身在GC堆内的对象行为良好，正常情况下很久都不发生full GC；</p></li><li><p>应用大量使用了NIO的direct memory，经常、反复的申请DirectByteBuffer</p></li><li><p>使用了-XX:+DisableExplicitGC</p></li></ol><p style="margin-bottom: 25px;">下面使用一些实例在看看在使用了DisableExplicitGC这个参数之后，到底会发生什么。</p><h4 style="margin-top: 20px;margin-bottom: 15px;padding-top: 10px;font-weight: bold;line-height: 1.5;">第一种:</h4><p style="margin-bottom: 25px;">native memory满了，但是young区没满，没有发生young gc回收DirectByteBuffer，所以堆外OOM（如果去掉DisableExplicitGC参数程序会一直有Full GC的信息输出，因为分配native memory的时候会主动调用System.GC()）</p><figure class="highlight java" style="margin-top: 20px;margin-bottom: 20px;overflow: auto;font-size: 13px;color: rgb(77, 77, 76);background: rgb(247, 247, 247);line-height: 1.6;border-radius: 1px;"><table width="NaN" style="width: 738px;"><tbody><tr style="background-color: rgb(249, 249, 249);"><td class="gutter" style="padding: 0px;text-align: left;vertical-align: middle;border-width: initial;border-style: none;border-color: initial;user-select: none;"><pre style="overflow: auto;"><span class="line" style="height: 20px;">1</span><br  /><span class="line" style="height: 20px;">2</span><br  /><span class="line" style="height: 20px;">3</span><br  /><span class="line" style="height: 20px;">4</span><br  /><span class="line" style="height: 20px;">5</span><br  /><span class="line" style="height: 20px;">6</span><br  /><span class="line" style="height: 20px;">7</span><br  /><span class="line" style="height: 20px;">8</span><br  /><span class="line" style="height: 20px;">9</span><br  /><span class="line" style="height: 20px;">10</span><br  /><span class="line" style="height: 20px;">11</span><br  /><span class="line" style="height: 20px;">12</span><br  /><span class="line" style="height: 20px;">13</span><br  /><span class="line" style="height: 20px;">14</span><br  /><span class="line" style="height: 20px;">15</span><br  /><span class="line" style="height: 20px;">16</span><br  /><span class="line" style="height: 20px;">17</span><br  /><span class="line" style="height: 20px;">18</span><br  /><span class="line" style="height: 20px;">19</span><br  /><span class="line" style="height: 20px;">20</span><br  /><span class="line" style="height: 20px;">21</span><br  /><span class="line" style="height: 20px;">22</span><br  /><span class="line" style="height: 20px;">23</span><br  /><span class="line" style="height: 20px;">24</span><br  /><span class="line" style="height: 20px;">25</span><br  /><span class="line" style="height: 20px;">26</span><br  /></pre></td><td class="code" style="padding: 0px;text-align: left;vertical-align: middle;border-width: initial;border-style: none;border-color: initial;"><pre style="overflow: auto;"><span class="line" style="height: 20px;">-Xmx64m</span><br  /><span class="line" style="height: 20px;">-Xms64m</span><br  /><span class="line" style="height: 20px;">-Xmn32m</span><br  /><span class="line" style="height: 20px;">-XX:+UseConcMarkSweepGC</span><br  /><span class="line" style="height: 20px;">-XX:+PrintGCDetails</span><br  /><span class="line" style="height: 20px;">-XX:+DisableExplicitGC<span class="comment" style="color: rgb(142, 144, 140);">//限制GC限制调用</span></span><br  /><span class="line" style="height: 20px;">-XX:MaxDirectMemorySize=<span class="number" style="color: rgb(113, 140, 0);">10</span>M<span class="comment" style="color: rgb(142, 144, 140);">//堆外10M</span></span><br  /><span class="line" style="height: 20px;"><span class="keyword" style="color: rgb(137, 89, 168);">int</span> i =<span class="number" style="color: rgb(113, 140, 0);">1</span>;</span><br  /><span class="line" style="height: 20px;"><span class="keyword" style="color: rgb(137, 89, 168);">while</span>(<span class="keyword" style="color: rgb(137, 89, 168);">true</span>){</span><br  /><span class="line" style="height: 20px;"> &nbsp; &nbsp;System.out.println(<span class="string" style="color: rgb(113, 140, 0);">"第"</span>+(i++)+<span class="string" style="color: rgb(113, 140, 0);">"次"</span>);</span><br  /><span class="line" style="height: 20px;"> &nbsp; &nbsp;ByteBuffer byteBuffer = ByteBuffer.allocateDirect( <span class="number" style="color: rgb(113, 140, 0);">1024</span>*<span class="number" style="color: rgb(113, 140, 0);">1024</span>);</span><br  /><span class="line" style="height: 20px;">}</span><br  /><span class="line" style="height: 20px;"> &nbsp;</span><br  /><span class="line" style="height: 20px;"><span class="comment" style="color: rgb(142, 144, 140);">//输出</span></span><br  /><span class="line" style="height: 20px;">第<span class="number" style="color: rgb(113, 140, 0);">10</span>次</span><br  /><span class="line" style="height: 20px;">第<span class="number" style="color: rgb(113, 140, 0);">11</span>次<span class="comment" style="color: rgb(142, 144, 140);">//10M就分配满了，分配第11次的时候会OOM</span></span><br  /><span class="line" style="height: 20px;">Heap</span><br  /><span class="line" style="height: 20px;"> par <span class="keyword" style="color: rgb(137, 89, 168);">new</span> generation &nbsp; total <span class="number" style="color: rgb(113, 140, 0);">29504</span>K, used <span class="number" style="color: rgb(113, 140, 0);">3149</span>K [<span class="number" style="color: rgb(113, 140, 0);">0x00000007f6e00000</span>, <span class="number" style="color: rgb(113, 140, 0);">0x00000007f8e00000</span>, <span class="number" style="color: rgb(113, 140, 0);">0x00000007f8e00000</span>)</span><br  /><span class="line" style="height: 20px;"> &nbsp;eden space <span class="number" style="color: rgb(113, 140, 0);">26240</span>K, &nbsp;<span class="number" style="color: rgb(113, 140, 0);">12</span>% used [<span class="number" style="color: rgb(113, 140, 0);">0x00000007f6e00000</span>, <span class="number" style="color: rgb(113, 140, 0);">0x00000007f7113578</span>, <span class="number" style="color: rgb(113, 140, 0);">0x00000007f87a0000</span>)<span class="comment" style="color: rgb(142, 144, 140);">//eden区只用了12%</span></span><br  /><span class="line" style="height: 20px;"> &nbsp;from space <span class="number" style="color: rgb(113, 140, 0);">3264</span>K, &nbsp; <span class="number" style="color: rgb(113, 140, 0);">0</span>% used [<span class="number" style="color: rgb(113, 140, 0);">0x00000007f87a0000</span>, <span class="number" style="color: rgb(113, 140, 0);">0x00000007f87a0000</span>, <span class="number" style="color: rgb(113, 140, 0);">0x00000007f8ad0000</span>)</span><br  /><span class="line" style="height: 20px;"> &nbsp;to &nbsp; space <span class="number" style="color: rgb(113, 140, 0);">3264</span>K, &nbsp; <span class="number" style="color: rgb(113, 140, 0);">0</span>% used [<span class="number" style="color: rgb(113, 140, 0);">0x00000007f8ad0000</span>, <span class="number" style="color: rgb(113, 140, 0);">0x00000007f8ad0000</span>, <span class="number" style="color: rgb(113, 140, 0);">0x00000007f8e00000</span>)</span><br  /><span class="line" style="height: 20px;"> concurrent mark-sweep generation total <span class="number" style="color: rgb(113, 140, 0);">32768</span>K, used <span class="number" style="color: rgb(113, 140, 0);">0</span>K [<span class="number" style="color: rgb(113, 140, 0);">0x00000007</span></span><br  /><span class="line" style="height: 20px;">Exception in thread <span class="string" style="color: rgb(113, 140, 0);">"main"</span> java.lang.OutOfMemoryError: Direct buffer memory</span><br  /><span class="line" style="height: 20px;"> &nbsp; &nbsp;at java.nio.Bits.reserveMemory(Bits.java:<span class="number" style="color: rgb(113, 140, 0);">658</span>)</span><br  /><span class="line" style="height: 20px;"> &nbsp; &nbsp;at java.nio.DirectByteBuffer.&lt;init&gt;(DirectByteBuffer.java:<span class="number" style="color: rgb(113, 140, 0);">123</span>)</span><br  /><span class="line" style="height: 20px;"> &nbsp; &nbsp;at java.nio.ByteBuffer.allocateDirect(ByteBuffer.java:<span class="number" style="color: rgb(113, 140, 0);">306</span>)</span></pre></td></tr></tbody></table></figure><h4 style="margin-top: 20px;margin-bottom: 15px;padding-top: 10px;font-weight: bold;line-height: 1.5;">第二种:</h4><p style="margin-bottom: 25px;">native memory没满，但是young区在native memory满之前提前满了，发生young gc回收DirectByteBuffer，不会发生OOM<br  />如果代码换成了下面这种(jvm参数一样),一次分配的native memory足够小，会导致在native memory没有分配满的情况下，发生young gc会搜DirectByteBuffer。同时会回收native memory</p><figure class="highlight java" style="margin-top: 20px;margin-bottom: 20px;overflow: auto;font-size: 13px;color: rgb(77, 77, 76);background: rgb(247, 247, 247);line-height: 1.6;border-radius: 1px;"><table width="NaN" style="width: 738px;"><tbody><tr style="background-color: rgb(249, 249, 249);"><td class="gutter" style="padding: 0px;text-align: left;vertical-align: middle;border-width: initial;border-style: none;border-color: initial;user-select: none;"><pre style="overflow: auto;"><span class="line" style="height: 20px;">1</span><br  /><span class="line" style="height: 20px;">2</span><br  /><span class="line" style="height: 20px;">3</span><br  /><span class="line" style="height: 20px;">4</span><br  /><span class="line" style="height: 20px;">5</span><br  /><span class="line" style="height: 20px;">6</span><br  /><span class="line" style="height: 20px;">7</span><br  /><span class="line" style="height: 20px;">8</span><br  /><span class="line" style="height: 20px;">9</span><br  /><span class="line" style="height: 20px;">10</span><br  /><span class="line" style="height: 20px;">11</span><br  /><span class="line" style="height: 20px;">12</span><br  /></pre></td><td class="code" style="padding: 0px;text-align: left;vertical-align: middle;border-width: initial;border-style: none;border-color: initial;"><pre style="overflow: auto;"><span class="line" style="height: 20px;">ByteBuffer byteBuffer = ByteBuffer.allocateDirect( <span class="number" style="color: rgb(113, 140, 0);">1024</span>/<span class="number" style="color: rgb(113, 140, 0);">2</span>/<span class="number" style="color: rgb(113, 140, 0);">2</span>/<span class="number" style="color: rgb(113, 140, 0);">2</span>/<span class="number" style="color: rgb(113, 140, 0);">2</span>/<span class="number" style="color: rgb(113, 140, 0);">2</span>);</span><br  /><span class="line" style="height: 20px;"><span class="comment" style="color: rgb(142, 144, 140);">//输出会有</span></span><br  /><span class="line" style="height: 20px;">[GC[ParNew: <span class="number" style="color: rgb(113, 140, 0);">29503</span>K-&gt;<span class="number" style="color: rgb(113, 140, 0);">3262</span>K(<span class="number" style="color: rgb(113, 140, 0);">29504</span>K), <span class="number" style="color: rgb(113, 140, 0);">0.0369960</span> secs] <span class="number" style="color: rgb(113, 140, 0);">44757</span>K-&gt;<span class="number" style="color: rgb(113, 140, 0);">25060</span>K(<span class="number" style="color: rgb(113, 140, 0);">62272</span>K), <span class="number" style="color: rgb(113, 140, 0);">0.0370220</span> secs] [Times: user=<span class="number" style="color: rgb(113, 140, 0);">0.18</span> sys=<span class="number" style="color: rgb(113, 140, 0);">0.00</span>, real=<span class="number" style="color: rgb(113, 140, 0);">0.04</span> secs]</span><br  /><span class="line" style="height: 20px;">...</span><br  /><span class="line" style="height: 20px;">...</span><br  /><span class="line" style="height: 20px;">Heap</span><br  /><span class="line" style="height: 20px;"><span class="comment" style="color: rgb(142, 144, 140);">//退出程序时会发现young区并没有满</span></span><br  /><span class="line" style="height: 20px;"> par <span class="keyword" style="color: rgb(137, 89, 168);">new</span> generation &nbsp; total <span class="number" style="color: rgb(113, 140, 0);">29504</span>K, used <span class="number" style="color: rgb(113, 140, 0);">12716</span>K [<span class="number" style="color: rgb(113, 140, 0);">0x00000007f6e00000</span>, <span class="number" style="color: rgb(113, 140, 0);">0x00000007f8e00000</span>, <span class="number" style="color: rgb(113, 140, 0);">0x00000007f8e00000</span>)</span><br  /><span class="line" style="height: 20px;"> &nbsp;eden space <span class="number" style="color: rgb(113, 140, 0);">26240</span>K, &nbsp;<span class="number" style="color: rgb(113, 140, 0);">36</span>% used</span><br  /><span class="line" style="height: 20px;"> [<span class="number" style="color: rgb(113, 140, 0);">0x00000007f6e00000</span>, <span class="number" style="color: rgb(113, 140, 0);">0x00000007f773b530</span>, <span class="number" style="color: rgb(113, 140, 0);">0x00000007f87a0000</span>)</span><br  /><span class="line" style="height: 20px;"> from space <span class="number" style="color: rgb(113, 140, 0);">3264</span>K, &nbsp;<span class="number" style="color: rgb(113, 140, 0);">99</span>% used [<span class="number" style="color: rgb(113, 140, 0);">0x00000007f8ad0000</span>, <span class="number" style="color: rgb(113, 140, 0);">0x00000007f8dffbc0</span>, <span class="number" style="color: rgb(113, 140, 0);">0x00000007f8e00000</span>)</span><br  /><span class="line" style="height: 20px;"> to &nbsp; space <span class="number" style="color: rgb(113, 140, 0);">3264</span>K, &nbsp; <span class="number" style="color: rgb(113, 140, 0);">0</span>% used</span></pre></td></tr></tbody></table></figure><h4 style="margin-top: 20px;margin-bottom: 15px;padding-top: 10px;font-weight: bold;line-height: 1.5;">第三种:</h4><p style="margin-bottom: 25px;">大量DirectByteBuffer对象移动到old gen。没有Full gc的发生，导致在程序中可能死掉的DirectByteBuffer对象没有回收掉，native memory则满了，发生OOM</p><figure class="highlight java" style="margin-top: 20px;margin-bottom: 20px;overflow: auto;font-size: 13px;color: rgb(77, 77, 76);background: rgb(247, 247, 247);line-height: 1.6;border-radius: 1px;"><table width="NaN" style="width: 738px;"><tbody><tr style="background-color: rgb(249, 249, 249);"><td class="gutter" style="padding: 0px;text-align: left;vertical-align: middle;border-width: initial;border-style: none;border-color: initial;user-select: none;"><pre style="overflow: auto;"><span class="line" style="height: 20px;">1</span><br  /><span class="line" style="height: 20px;">2</span><br  /><span class="line" style="height: 20px;">3</span><br  /><span class="line" style="height: 20px;">4</span><br  /><span class="line" style="height: 20px;">5</span><br  /><span class="line" style="height: 20px;">6</span><br  /><span class="line" style="height: 20px;">7</span><br  /><span class="line" style="height: 20px;">8</span><br  /><span class="line" style="height: 20px;">9</span><br  /><span class="line" style="height: 20px;">10</span><br  /><span class="line" style="height: 20px;">11</span><br  /><span class="line" style="height: 20px;">12</span><br  /><span class="line" style="height: 20px;">13</span><br  /><span class="line" style="height: 20px;">14</span><br  /><span class="line" style="height: 20px;">15</span><br  /><span class="line" style="height: 20px;">16</span><br  /><span class="line" style="height: 20px;">17</span><br  /><span class="line" style="height: 20px;">18</span><br  /><span class="line" style="height: 20px;">19</span><br  /><span class="line" style="height: 20px;">20</span><br  /><span class="line" style="height: 20px;">21</span><br  /><span class="line" style="height: 20px;">22</span><br  /><span class="line" style="height: 20px;">23</span><br  /><span class="line" style="height: 20px;">24</span><br  /><span class="line" style="height: 20px;">25</span><br  /><span class="line" style="height: 20px;">26</span><br  /><span class="line" style="height: 20px;">27</span><br  /><span class="line" style="height: 20px;">28</span><br  /><span class="line" style="height: 20px;">29</span><br  /><span class="line" style="height: 20px;">30</span><br  /><span class="line" style="height: 20px;">31</span><br  /><span class="line" style="height: 20px;">32</span><br  /><span class="line" style="height: 20px;">33</span><br  /></pre></td><td class="code" style="padding: 0px;text-align: left;vertical-align: middle;border-width: initial;border-style: none;border-color: initial;"><pre style="overflow: auto;"><span class="line" style="height: 20px;"></span><br  /><span class="line" style="height: 20px;">-Xmx64m</span><br  /><span class="line" style="height: 20px;">-Xms64m</span><br  /><span class="line" style="height: 20px;">-Xmn32m</span><br  /><span class="line" style="height: 20px;">-XX:+PrintGCDetails</span><br  /><span class="line" style="height: 20px;">-XX:MaxTenuringThreshold=<span class="number" style="color: rgb(113, 140, 0);">1</span><span class="comment" style="color: rgb(142, 144, 140);">//设置进去old gen的寿命是1，默认是15次才进入old gen</span></span><br  /><span class="line" style="height: 20px;">-XX:MaxDirectMemorySize=<span class="number" style="color: rgb(113, 140, 0);">10</span>M</span><br  /><span class="line" style="height: 20px;">-XX:+DisableExplicitGC<span class="comment" style="color: rgb(142, 144, 140);">//不能显示full gc</span></span><br  /><span class="line" style="height: 20px;"> &nbsp;</span><br  /><span class="line" style="height: 20px;"><span class="keyword" style="color: rgb(137, 89, 168);">int</span> i = <span class="number" style="color: rgb(113, 140, 0);">1</span>;</span><br  /><span class="line" style="height: 20px;">List&lt;ByteBuffer&gt; list = <span class="keyword" style="color: rgb(137, 89, 168);">new</span> ArrayList&lt;ByteBuffer&gt;();</span><br  /><span class="line" style="height: 20px;"><span class="keyword" style="color: rgb(137, 89, 168);">while</span> (<span class="keyword" style="color: rgb(137, 89, 168);">true</span>) {</span><br  /><span class="line" style="height: 20px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;System.out.println(<span class="string" style="color: rgb(113, 140, 0);">"第"</span> + (i++) + <span class="string" style="color: rgb(113, 140, 0);">"次"</span>);</span><br  /><span class="line" style="height: 20px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;ByteBuffer.allocate(<span class="number" style="color: rgb(113, 140, 0);">1024</span> * <span class="number" style="color: rgb(113, 140, 0);">1024</span>);<span class="comment" style="color: rgb(142, 144, 140);">//分配堆内内存</span></span><br  /><span class="line" style="height: 20px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;ByteBuffer byteBuffer = ByteBuffer.allocateDirect(<span class="number" style="color: rgb(113, 140, 0);">1024</span> / <span class="number" style="color: rgb(113, 140, 0);">2</span> / <span class="number" style="color: rgb(113, 140, 0);">2</span> / <span class="number" style="color: rgb(113, 140, 0);">2</span> );</span><br  /><span class="line" style="height: 20px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;list.add(byteBuffer);<span class="comment" style="color: rgb(142, 144, 140);">//保证引用不被younggc</span></span><br  /><span class="line" style="height: 20px;"> &nbsp; &nbsp; &nbsp; &nbsp;}</span><br  /><span class="line" style="height: 20px;"><span class="comment" style="color: rgb(142, 144, 140);">//输出</span></span><br  /><span class="line" style="height: 20px;">[GC[ParNew: <span class="number" style="color: rgb(113, 140, 0);">25620</span>K-&gt;<span class="number" style="color: rgb(113, 140, 0);">6</span>K(<span class="number" style="color: rgb(113, 140, 0);">29504</span>K), <span class="number" style="color: rgb(113, 140, 0);">0.0004310</span> secs] <span class="number" style="color: rgb(113, 140, 0);">38176</span>K-&gt;<span class="number" style="color: rgb(113, 140, 0);">12564</span>K(<span class="number" style="color: rgb(113, 140, 0);">62272</span>K), <span class="number" style="color: rgb(113, 140, 0);">0.0004450</span> secs] [Times: user=<span class="number" style="color: rgb(113, 140, 0);">0.00</span> sys=<span class="number" style="color: rgb(113, 140, 0);">0.00</span>, real=<span class="number" style="color: rgb(113, 140, 0);">0.00</span> secs]</span><br  /><span class="line" style="height: 20px;"><span class="comment" style="color: rgb(142, 144, 140);">//中途有一些young gc</span></span><br  /><span class="line" style="height: 20px;"><span class="comment" style="color: rgb(142, 144, 140);">//.....</span></span><br  /><span class="line" style="height: 20px;"><span class="comment" style="color: rgb(142, 144, 140);">//最终输出</span></span><br  /><span class="line" style="height: 20px;">Heap</span><br  /><span class="line" style="height: 20px;"><span class="comment" style="color: rgb(142, 144, 140);">//young 区也没有满</span></span><br  /><span class="line" style="height: 20px;"> PSYoungGen &nbsp; &nbsp; &nbsp;total <span class="number" style="color: rgb(113, 140, 0);">32256</span>K, used <span class="number" style="color: rgb(113, 140, 0);">26419</span>K [<span class="number" style="color: rgb(113, 140, 0);">0x000000010d700000</span>, <span class="number" style="color: rgb(113, 140, 0);">0x000000010f700000</span>, <span class="number" style="color: rgb(113, 140, 0);">0x000000010f700000</span>)</span><br  /><span class="line" style="height: 20px;"> &nbsp;eden space <span class="number" style="color: rgb(113, 140, 0);">31744</span>K, <span class="number" style="color: rgb(113, 140, 0);">82</span>% used [<span class="number" style="color: rgb(113, 140, 0);">0x000000010d700000</span>,<span class="number" style="color: rgb(113, 140, 0);">0x000000010f0a4c70</span>,<span class="number" style="color: rgb(113, 140, 0);">0x000000010f600000</span>)</span><br  /><span class="line" style="height: 20px;"> &nbsp;from space <span class="number" style="color: rgb(113, 140, 0);">512</span>K, <span class="number" style="color: rgb(113, 140, 0);">31</span>% used [<span class="number" style="color: rgb(113, 140, 0);">0x000000010f680000</span>,<span class="number" style="color: rgb(113, 140, 0);">0x000000010f6a8000</span>,<span class="number" style="color: rgb(113, 140, 0);">0x000000010f700000</span>)</span><br  /><span class="line" style="height: 20px;"> &nbsp;to &nbsp; space <span class="number" style="color: rgb(113, 140, 0);">512</span>K, <span class="number" style="color: rgb(113, 140, 0);">0</span>% used [<span class="number" style="color: rgb(113, 140, 0);">0x000000010f600000</span>,<span class="number" style="color: rgb(113, 140, 0);">0x000000010f600000</span>,<span class="number" style="color: rgb(113, 140, 0);">0x000000010f680000</span>)</span><br  /><span class="line" style="height: 20px;"><span class="comment" style="color: rgb(142, 144, 140);">//old gen 已经用了62%了</span></span><br  /><span class="line" style="height: 20px;"> ParOldGen &nbsp; &nbsp; &nbsp; total <span class="number" style="color: rgb(113, 140, 0);">32768</span>K, used <span class="number" style="color: rgb(113, 140, 0);">20586</span>K [<span class="number" style="color: rgb(113, 140, 0);">0x000000010b700000</span>, <span class="number" style="color: rgb(113, 140, 0);">0x000000010d700000</span>, <span class="number" style="color: rgb(113, 140, 0);">0x000000010d700000</span>)</span><br  /><span class="line" style="height: 20px;"> &nbsp;object space <span class="number" style="color: rgb(113, 140, 0);">32768</span>K, <span class="number" style="color: rgb(113, 140, 0);">62</span>% used [<span class="number" style="color: rgb(113, 140, 0);">0x000000010b700000</span>,<span class="number" style="color: rgb(113, 140, 0);">0x000000010cb1a908</span>,<span class="number" style="color: rgb(113, 140, 0);">0x000000010d700000</span>)</span><br  /><span class="line" style="height: 20px;"> PSPermGen &nbsp; &nbsp; &nbsp; total <span class="number" style="color: rgb(113, 140, 0);">21504</span>K, used <span class="number" style="color: rgb(113, 140, 0);">3097</span>K [<span class="number" style="color: rgb(113, 140, 0);">0x0000000106500000</span>, <span class="number" style="color: rgb(113, 140, 0);">0x0000000107a00000</span>, <span class="number" style="color: rgb(113, 140, 0);">0x000000010b700000</span>)</span><br  /><span class="line" style="height: 20px;"> &nbsp;object space <span class="number" style="color: rgb(113, 140, 0);">21504</span>K, <span class="number" style="color: rgb(113, 140, 0);">14</span>% used [<span class="number" style="color: rgb(113, 140, 0);">0x0000000106500000</span>,<span class="number" style="color: rgb(113, 140, 0);">0x00000001068065e8</span>,<span class="number" style="color: rgb(113, 140, 0);">0x0000000107a00000</span>)</span><br  /></pre></td></tr></tbody></table></figure><p><br  /></p><p style="margin-bottom: 25px;">如果你在使用Oracle/Sun JDK 6，应用里有任何地方用了direct memory，那么使用-XX:+DisableExplicitGC要小心。如果用了该参数而且遇到direct memory的OOM，可以尝试去掉该参数看是否能避开这种OOM</p>
                </div>
                

                
                <div class="ct_mpda_wrp" id="js_sponsor_ad_area" style="display:none;"></div>

                
                                <div class="reward_area tc reward_area_primary" id="js_reward_area" style="display:none;">
                    <div class="reward-avatar" style="display: none;" id="js_reward_avatar">
                        <img src="" alt="" id="js_reward_author_head">
                    </div>
                    
                                        <div class="reward-author" style="display: none;" id="js_reward_author">谢照东</div>
                                       

                                        <p>
                        <a class="reward_button" id='js_reward_link' href="##"><span id="js_reward_link_text">赞赏</span></a>
                    </p>
                    <div id="js_reward_inner" class="reward_area_inner" style="display:none;">
                        <p class="weui-loadmore weui-loadmore_line reward_user_tips" id="js_reward_total_parent">
                          <span class="weui-loadmore__tips"><a href="##" id="js_reward_total"></a>&nbsp;人<span id="js_reward_total_text">赞赏</span></span>
                        </p>
                        
                        <div id="js_reward_list" class="reward_user_list"></div>
                    </div>
                </div>
                                <div class="reward_qrcode_area reward_area tc" id="js_reward_qrcode" style="display:none;">
                    <p class="tips_global">长按二维码向我转账</p>
                                        <p class="reward_tips"></p>
                    <span class="reward_qrcode_img_wrp"><img class="reward_qrcode_img" id="js_reward_qrcode_img"></span>
                    <p class="tips_global">受苹果公司新规定影响，微信 iOS 版的赞赏功能被关闭，可通过二维码转账支持公众号。</p>
                </div>
                                                
                
                                <a class="original_tool_area" id="copyright_info" href="##">
                    <div class="flex_cell original_cell">
                        <div class="flex_cell_bd flex_cell_primary">
                          <p class="tips_global_primary">文章转载自公众号</p>
                        </div>
                        <div class="flex_cell_ft icon_access">
                            <span class="radius_avatar">
                                                                <img class="avatar" src="http://wx.qlogo.cn/mmhead/Q3auHgzwzM79dwwchkLC8nVb0nicS8zARiakWdQ2o54HpbL3xcWYnM1Q/0" alt="EchoQME">
                                                            </span>
                            <strong class="original_cell_nickname">
                              EchoQME
                            </strong>
                        </div>
                    </div>
                </a>
                            </div></div></body>